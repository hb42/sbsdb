<div class="flex-col">
  <sbsdb-head>
    <button
      mat-icon-button
      title="Erweiterte Suche"
      (click)="apService.filterService.toggleExtendedFilter()"
      [class.ext-filter-button-select]="!apService.filterService.stdFilter"
    >
      <mat-icon>find_in_page</mat-icon>
    </button>
    <button mat-icon-button title="Als CSV ausgeben"><mat-icon>share</mat-icon></button>
    <button mat-icon-button title="Neuer Arbeitsplatz" (click)="apService.test()">
      <mat-icon>add_circle_outline</mat-icon>
    </button>
    <button mat-icon-button title="Einstellungen" [matMenuTriggerFor]="tableMenu">
      <mat-icon>menu</mat-icon>
    </button>
  </sbsdb-head>

  <sbsdb-ap-filter
    *ngIf="!apService.filterService.stdFilter"
    [data]="apService.filterService.filterElement"
  ></sbsdb-ap-filter>

  <div class="flex-content">
    <!-- empty table -->
    <div class="spinner-container" *ngIf="apService.loading">
      <mat-spinner></mat-spinner>
    </div>
    <!-- TABLE begin -->
    <table
      mat-table
      [dataSource]="apService.apDataSource"
      matSort
      multiTemplateDataRows
      (matSortChange)="apService.onSort($event)"
      [class.wrap-cell]="apService.tableWrapCell"
    >
      <!--- Note that these columns can be defined in any order.
            The actual rendered columns are set as a property on the row definition" -->
      <!-- COLUMN checkbox begin -->
      <ng-container matColumnDef="select">
        <!-- HEAD -->
        <th mat-header-cell *matHeaderCellDef>
          <button
            style="font-size: 18px; width: 16px"
            mat-icon-button
            (click)="apService.toggleSelection()"
          >
            <mat-icon
              inline
              title="Nur Ausgewählte anzeigen"
              *ngIf="!apService.filterService.showSelected"
              color="primary"
              >filter_alt
              <!--              check_circle_outline-->
            </mat-icon>
            <mat-icon
              inline
              title="Auch nicht Ausgewählte anzeigen"
              *ngIf="apService.filterService.showSelected"
              color="primary"
              >unpublished
              <!--              check_circle-->
            </mat-icon>
          </button>
          <mat-checkbox
            (change)="$event ? apService.masterToggle() : null"
            [checked]="apService.isAllSelected()"
            [indeterminate]="apService.isSelected() && !apService.isAllSelected()"
            color="primary"
            title="alle auwählen"
          >
          </mat-checkbox>
        </th>
        <!-- DATA -->
        <td mat-cell *matCellDef="let row">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="$event ? apService.rowToggle(row) : null"
            [checked]="row.selected"
            color="primary"
          >
          </mat-checkbox>
        </td>
      </ng-container>
      <!-- COLUMN checkbox end -->

      <!-- COLUMN aptyp begin -->
      <ng-container matColumnDef="aptyp">
        <!-- HEAD -->
        <th mat-header-cell *matHeaderCellDef>
          <sbsdb-ap-header-cell
            #firstfilter
            (keydown.shift.tab)="
              focusLastFilter(); $event.preventDefault(); $event.stopPropagation()
            "
            [column]="apService.getColumn('aptyp')"
            [showFilter]="apService.filterService.stdFilter"
            [tabindex]="apService.displayedColumns.indexOf('aptyp') + 1"
          ></sbsdb-ap-header-cell>
        </th>
        <!-- DATA -->
        <td
          mat-cell
          *matCellDef="let element"
          class="aptyp highlight-when-expanded"
          (click)="apService.clickForDetails ? apService.expandApRow(element, $event) : ''"
        >
          <div
            [class.md-primary-color]="apService.linkcolor2 && apService.sortLinks"
            [class.md-accent-color]="!apService.linkcolor2 && apService.sortLinks"
          >
            <button
              mat-icon-button
              [color]="apService.linkcolor"
              *ngIf="!apService.clickForDetails"
              (click)="apService.expandApRow(element, $event)"
            >
              <mat-icon *ngIf="element.expanded">arrow_drop_down</mat-icon>
              <mat-icon *ngIf="!element.expanded">arrow_right</mat-icon>
            </button>
            <span
              class="highlight-when-expanded"
              [class.pseudo-button]="apService.sortLinks"
              (click)="
                apService.sortLinks && !element.expanded
                  ? apService.filterByAptyp(element, $event)
                  : ''
              "
            >
              {{ element.apTypBezeichnung }}
            </span>
          </div>
        </td>
      </ng-container>
      <!-- COLUMN aptyp end -->

      <!-- COLUMN apname begin -->
      <ng-container matColumnDef="apname">
        <!-- HEAD -->
        <th mat-header-cell *matHeaderCellDef>
          <sbsdb-ap-header-cell
            [column]="apService.getColumn('apname')"
            [showFilter]="apService.filterService.stdFilter"
            [tabindex]="apService.displayedColumns.indexOf('apname') + 1"
          ></sbsdb-ap-header-cell>
        </th>
        <!-- DATA -->
        <td
          mat-cell
          *matCellDef="let element"
          class="highlight-when-expanded"
          (click)="apService.clickForDetails ? apService.expandApRow(element, $event) : ''"
        >
          <div (mouseenter)="apService.tooltipOnEllipsis($event)">{{ element.apname }}</div>
        </td>
      </ng-container>
      <!-- COLUMN apname end -->

      <!-- COLUMN betrst begin -->
      <ng-container matColumnDef="betrst">
        <!-- HEAD -->
        <th mat-header-cell *matHeaderCellDef>
          <sbsdb-ap-header-cell
            [column]="apService.getColumn('betrst')"
            [labelChange]="apService.userSettings.showStandort"
            [showFilter]="apService.filterService.stdFilter"
            [tabindex]="apService.displayedColumns.indexOf('betrst') + 1"
          ></sbsdb-ap-header-cell>
        </th>
        <!-- DATA -->
        <td
          mat-cell
          *matCellDef="let element"
          class="highlight-when-expanded"
          (click)="apService.clickForDetails ? apService.expandApRow(element, $event) : ''"
        >
          <div
            [class.md-primary-color]="apService.linkcolor2 && apService.sortLinks"
            [class.md-accent-color]="!apService.linkcolor2 && apService.sortLinks"
            [class.pseudo-button]="apService.sortLinks"
            class="highlight-when-expanded"
            (click)="
              apService.sortLinks && !element.expanded
                ? apService.filterByBetrst(element, $event)
                : ''
            "
            (mouseenter)="apService.tooltipOnEllipsis($event)"
          >
            <span *ngIf="apService.userSettings.showStandort">{{ element.oe.betriebsstelle }}</span>
            <span *ngIf="!apService.userSettings.showStandort">{{
              element.verantwOe.betriebsstelle
            }}</span>
          </div>
        </td>
      </ng-container>
      <!-- COLUMN betrst end -->

      <!-- COLUMN bezeichnung begin -->
      <ng-container matColumnDef="bezeichnung">
        <!-- HEAD -->
        <th mat-header-cell *matHeaderCellDef>
          <sbsdb-ap-header-cell
            [column]="apService.getColumn('bezeichnung')"
            [showFilter]="apService.filterService.stdFilter"
            [tabindex]="apService.displayedColumns.indexOf('bezeichnung') + 1"
          ></sbsdb-ap-header-cell>
        </th>
        <!-- DATA -->
        <td
          mat-cell
          *matCellDef="let element"
          class="highlight-when-expanded"
          (click)="apService.clickForDetails ? apService.expandApRow(element, $event) : ''"
        >
          <div (mouseenter)="apService.tooltipOnEllipsis($event)">{{ element.bezeichnung }}</div>
        </td>
      </ng-container>
      <!-- COLUMN bezeichnung end -->

      <!-- COLUMN IP begin -->
      <ng-container matColumnDef="ip">
        <!-- HEAD -->
        <th mat-header-cell *matHeaderCellDef>
          <sbsdb-ap-header-cell
            [column]="apService.getColumn('ip')"
            [showFilter]="apService.filterService.stdFilter"
            [tabindex]="apService.displayedColumns.indexOf('ip') + 1"
          ></sbsdb-ap-header-cell>
        </th>
        <!-- DATA -->
        <td
          mat-cell
          *matCellDef="let element"
          (click)="apService.clickForDetails ? apService.expandApRow(element, $event) : ''"
          title="{{ element.macStr }}"
        >
          <div>
            <span class="ip-cell">{{ element.ipStr }} </span>
            <!-- MAC nur bei aktivem Filter anzeigen (nicht ueber isDirty pruefen wg. backspace) -->
            <span *ngIf="apService.getColumn('ip').filterControl.value">{{ element.macStr }}</span>
          </div>
        </td>
      </ng-container>
      <!-- COLUMN IP end -->

      <!-- COLUMN hardware begin -->
      <ng-container matColumnDef="hardware">
        <!-- HEAD -->
        <th mat-header-cell *matHeaderCellDef>
          <sbsdb-ap-header-cell
            #lastfilter
            (keydown.tab)="focusFirstFilter(); $event.preventDefault(); $event.stopPropagation()"
            [column]="apService.getColumn('hardware')"
            [showFilter]="apService.filterService.stdFilter"
            [tabindex]="apService.displayedColumns.indexOf('hardware') + 1"
          ></sbsdb-ap-header-cell>
        </th>
        <!-- DATA -->
        <td
          mat-cell
          *matCellDef="let element"
          (click)="apService.clickForDetails ? apService.expandApRow(element, $event) : ''"
        >
          <div (mouseenter)="apService.tooltipOnEllipsis($event)">{{ element.hwStr }}</div>
        </td>
      </ng-container>
      <!-- COLUMN hardware end -->

      <!-- COLUMN menu begin -->
      <ng-container matColumnDef="menu">
        <!-- HEAD -->
        <th mat-header-cell *matHeaderCellDef>
          <button
            style="font-size: 18px; height: 1px"
            mat-icon-button
            (click)="apService.expandAllRows()"
          >
            <mat-icon inline title="Alle aufklappen" color="primary">web_asset </mat-icon>
          </button>
          <button
            style="font-size: 18px; height: 1px"
            mat-icon-button
            (click)="apService.collapseAllRows()"
          >
            <mat-icon inline title="Alle zuklappen" color="primary">maximize </mat-icon>
          </button>
        </th>
        <!-- DATA -->
        <td mat-cell *matCellDef="let element">
          <button
            mat-icon-button
            [matMenuTriggerFor]="apMenu"
            [matMenuTriggerData]="{ ap: element }"
            [color]="apService.linkcolor"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
        </td>
      </ng-container>
      <!-- COLUMN menu end -->

      <!-- COLUMN details template begin -->
      <ng-container matColumnDef="apdetails">
        <td
          mat-cell
          *matCellDef="let element"
          [colSpan]="apService.displayedColumns.length"
          class="ap-detail-cell"
        >
          <sbsdb-ap-detail-cell [element]="element"></sbsdb-ap-detail-cell>
          <!--          &lt;!&ndash;            *ngIf="apService.expandedRow === element"&ndash;&gt;-->
          <!--          <div-->
          <!--            [@detailExpand]="element.expanded ? 'expanded' : 'collapsed'"-->
          <!--            class="ap-detail-content"-->
          <!--          >-->
          <!--            <div class="ap-detail-content-row">-->
          <!--              <div class="ap-detail-margin ap-detail-standort-text">Standort</div>-->
          <!--              <div class="ap-detail-margin">-->
          <!--                {{ ("000" + element.oe.bstNr).slice(-3) }}<br />-->
          <!--                {{ element.oe.betriebsstelle }}<br /><br />-->
          <!--                {{ element.oe.strasse ? element.oe.strasse + " " : ""-->
          <!--                }}{{ element.oe.hausnr ? element.oe.hausnr : "" }}<br />-->
          <!--                {{ element.oe.plz ? element.oe.plz + " " : ""-->
          <!--                }}{{ element.oe.ort ? element.oe.ort : "" }}-->
          <!--              </div>-->
          <!--              <div class="ap-detail-margin"></div>-->
          <!--              <div *ngIf="element.oe.oeff" class="ap-detail-margin ap-detail-oeff">-->
          <!--                Öffnungszeiten<br />{{ element.oe.oeff }}-->
          <!--              </div>-->
          <!--            </div>-->
          <!--            <div class="ap-detail-content-row">-->
          <!--              <div *ngIf="element.verantwOe" class="ap-detail-margin ap-detail-standort-text">-->
          <!--                Verantwortliche OE-->
          <!--              </div>-->
          <!--              <div class="ap-detail-margin">-->
          <!--                {{ ("000" + element.verantwOe.bstNr).slice(-3) }} - -->
          <!--                {{ element.verantwOe.betriebsstelle }}-->
          <!--              </div>-->
          <!--            </div>-->
          <!--            <div class="ap-detail-content-row">-->
          <!--              <div class="ap-detail-margin">-->
          <!--                <table>-->
          <!--                  <thead>-->
          <!--                    <th colspan="4">Hardware</th>-->
          <!--                  </thead>-->
          <!--                  <thead>-->
          <!--                    <th>Typ</th>-->
          <!--                    <th>Hardware</th>-->
          <!--                    <th>IP</th>-->
          <!--                    <th>MAC</th>-->
          <!--                  </thead>-->
          <!--                  <tr *ngFor="let hw of element.hw">-->
          <!--                    &lt;!&ndash;                <td *ngIf="!hw.pri">&ndash;&gt;-->
          <!--                    <td>-->
          <!--                      {{ hw.hwKonfig.hwTypBezeichnung }}-->
          <!--                    </td>-->
          <!--                    <td>-->
          <!--                      {{-->
          <!--                        hw.hwKonfig.hwTypFlag !== fremdeHwFlag-->
          <!--                          ? hw.hwKonfig.hersteller +-->
          <!--                            " - " +-->
          <!--                            hw.hwKonfig.bezeichnung +-->
          <!--                            " [" +-->
          <!--                            hw.sernr +-->
          <!--                            "]"-->
          <!--                          : ""-->
          <!--                      }}-->
          <!--                    </td>-->
          <!--                    <td [title]="hw.vlanStr">-->
          <!--                      {{ hw.ipStr }}-->
          <!--                    </td>-->
          <!--                    <td>{{ hw.macStr }}</td>-->
          <!--                  </tr>-->
          <!--                </table>-->
          <!--              </div>-->
          <!--              &lt;!&ndash;              <div class="ap-detail-margin">&ndash;&gt;-->
          <!--              &lt;!&ndash;                <table>&ndash;&gt;-->
          <!--              &lt;!&ndash;                  <th colspan="2">IP/MAC</th>&ndash;&gt;-->
          <!--              &lt;!&ndash;                  <tr *ngFor="let vl of element.vlan">&ndash;&gt;-->
          <!--              &lt;!&ndash;                    <td>&ndash;&gt;-->
          <!--              &lt;!&ndash;                      {{ vl.bezeichnung }}<br />&ndash;&gt;-->
          <!--              &lt;!&ndash;                      {{ apService.getIpString(vl.vlan + vl.ip) }}&ndash;&gt;-->
          <!--              &lt;!&ndash;                    </td>&ndash;&gt;-->
          <!--              &lt;!&ndash;                    <td>{{ apService.getMacString(vl.mac) }}</td>&ndash;&gt;-->
          <!--              &lt;!&ndash;                  </tr>&ndash;&gt;-->
          <!--              &lt;!&ndash;                </table>&ndash;&gt;-->
          <!--              &lt;!&ndash;              </div>&ndash;&gt;-->
          <!--              <div class="ap-detail-margin">-->
          <!--                <table>-->
          <!--                  <th colspan="2">Sonstige Informationen</th>-->
          <!--                  <tr *ngFor="let tag of element.tags">-->
          <!--                    <td [colSpan]="tag.flag === aptypeFlag ? 2 : 1">{{ tag.bezeichnung }}</td>-->
          <!--                    <td *ngIf="tag.flag !== aptypeFlag">{{ tag.text }}</td>-->
          <!--                  </tr>-->
          <!--                </table>-->
          <!--              </div>-->
          <!--            </div>-->
          <!--            <div class="ap-detail-bemerk">{{ element.bemerkung }}</div>-->
          <!--          </div>-->
        </td>
      </ng-container>
      <!-- COLUMN details template end -->

      <!-- footer template -->
      <ng-container matColumnDef="footer">
        <td mat-footer-cell *matFooterCellDef [colSpan]="apService.displayedColumns.length">
          <div>
            {{ apService.apDataSource.filteredData.length }} APs von
            {{ apService.apDataSource.data.length }}
          </div>
          <div class="fill"></div>
          <div style="font-size: 10px">
            <!--  rechtsbuendiger Text -->
          </div>
        </td>
      </ng-container>

      <!-- ROW details template begin -->
      <tr mat-header-row *matHeaderRowDef="apService.displayedColumns; sticky: true"></tr>
      <tr
        mat-row
        *matRowDef="let element; columns: apService.displayedColumns"
        class="ap-row"
        [class.ap-detail-expanded]="element.expanded"
        [class.ap-row-clickable]="apService.clickForDetails"
      ></tr>
      <tr
        mat-row
        *matRowDef="let element; columns: ['apdetails']"
        class="ap-detail-row"
        [class.ap-detail-content-expanded]="element.expanded"
      ></tr>
      <!-- ROW details template end -->
    </table>
    <!-- TABLE end-->
  </div>

  <!-- ?? background: linear-gradient(to top, #fd3232 0%, #ce0000 100%); -->
  <mat-paginator
    [pageSizeOptions]="[100, 250, 500, 1000]"
    showFirstLastButtons
    (page)="apService.onPage($event)"
    class="paginator"
    color="primary"
  ></mat-paginator>
</div>

<!-- Infos zum Filter im paginator
     TODO es funktioniert, aber Formatierung und Positionierung sind noch nicht optimal
          das Zusammenspiel mit <sbsdb-status> ist auch noch offen
     -->
<!--<ng-template #pagInsert>-->
<div #pagInsert style="display: flex; flex: auto; margin-left: 10px">
  Ausgewählt: {{ apService.selectCount() }} von
  {{ apService.apDataSource.filteredData.length }}
</div>
<!--</ng-template>-->

<sbsdb-status [bottom]="20" [left]="20" [text]="apService.statusText"></sbsdb-status>

<!-- Header-Menue -->
<mat-menu #tableMenu="matMenu">
  <ng-template matMenuContent>
    <!--    <button mat-menu-item class="menue-entry" (click)="extendedFilter()">-->
    <!--      <mat-icon>find_in_page</mat-icon>-->
    <!--      Erweiterte Suche-->
    <!--    </button>-->
    <button mat-menu-item class="menue-entry" (click)="apService.filterService.resetStdFilters()">
      <mat-icon>close</mat-icon>
      Alle Filter löschen
    </button>
    <button
      mat-menu-item
      class="menue-entry"
      (click)="apService.userSettings.showStandort = !apService.userSettings.showStandort"
    >
      <mat-icon>home</mat-icon>
      Standort anzeigen
      <div class="fill"></div>
      <mat-icon class="menue-checkbox">{{
        apService.userSettings.showStandort ? "check_box" : "check_box_outline_blank"
      }}</mat-icon>
    </button>
    <button
      mat-menu-item
      class="menue-entry"
      (click)="apService.userSettings.searchSonstHw = !apService.userSettings.searchSonstHw"
    >
      <mat-icon>devices</mat-icon>
      Suche in sonstiger HW
      <div class="fill"></div>
      <mat-icon class="menue-checkbox">{{
        apService.userSettings.searchSonstHw ? "check_box" : "check_box_outline_blank"
      }}</mat-icon>
    </button>
    <button
      mat-menu-item
      class="menue-entry"
      (click)="apService.tableWrapCell = !apService.tableWrapCell"
    >
      <mat-icon>wrap_text</mat-icon>
      Zeilenumbruch
      <div class="fill"></div>
      <mat-icon class="menue-checkbox">{{
        apService.tableWrapCell ? "check_box" : "check_box_outline_blank"
      }}</mat-icon>
    </button>
    <button
      mat-menu-item
      class="menue-entry"
      (click)="apService.clickForDetails = !apService.clickForDetails"
    >
      <mat-icon>touch_app</mat-icon>
      Zeilenklick
      <div class="fill"></div>
      <mat-icon class="menue-checkbox">{{
        apService.clickForDetails ? "check_box" : "check_box_outline_blank"
      }}</mat-icon>
    </button>
    <button
      mat-menu-item
      class="menue-entry"
      (click)="
        apService.linkcolor === 'primary'
          ? (apService.linkcolor = 'accent')
          : (apService.linkcolor = 'primary')
      "
    >
      <mat-icon>format_color_text</mat-icon>
      toggle menu color
    </button>
    <button
      mat-menu-item
      class="menue-entry"
      (click)="apService.linkcolor2 = !apService.linkcolor2"
    >
      <mat-icon>format_color_text</mat-icon>
      toggle link color
    </button>
    <button mat-menu-item class="menue-entry" (click)="apService.sortLinks = !apService.sortLinks">
      <mat-icon>format_color_text</mat-icon>
      toggle show links
    </button>
  </ng-template>
</mat-menu>

<!-- Zeilen-Menue -->
<mat-menu #apMenu="matMenu">
  <ng-template matMenuContent let-ap="ap">
    <button mat-menu-item (click)="apService.test()">Test1</button>
    <button mat-menu-item>Test2</button>
    <button mat-menu-item *ngIf="ap.apTypBezeichnung.indexOf('Thin') !== -1">Test3 TC</button>
  </ng-template>
</mat-menu>
